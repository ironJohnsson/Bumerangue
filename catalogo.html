<!doctype html>
<html lang="pt-BR">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Cat√°logo</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--verde:#2e8b57;--fundo:#fffaf0}
body{font-family:Roboto, sans-serif;background:var(--fundo);color:#222;margin:0}
header,footer{background:var(--verde);color:#fff;padding:12px;text-align:center}
.cats{display:flex;gap:8px;justify-content:center;padding:18px}
.cat-btn{padding:8px 12px;border:2px solid var(--verde);background:#fff;color:var(--verde);border-radius:8px;cursor:pointer}
.cat-btn.active{background:var(--verde);color:#fff}
.subcats{display:flex;gap:8px;justify-content:center;margin-bottom:12px}
.subcat-btn{padding:6px 10px;border-radius:8px;border:2px solid var(--verde);background:#fff;color:var(--verde);cursor:pointer}
.catalogo{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px;padding:12px}
.produto{background:#fff;border-radius:10px;padding:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);text-align:center}
button.small{padding:6px 10px;border-radius:8px;background:var(--verde);color:#fff;border:none;cursor:pointer}
table{width:100%;border-collapse:collapse;margin:12px auto}
th,td{padding:8px;border:1px solid #ddd;text-align:center}
th{background:var(--verde);color:#fff}
.modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);align-items:center;justify-content:center}
.modal.show{display:flex}
.modal-card{background:#fff;padding:18px;border-radius:10px;width:92%;max-width:560px}
.close{position:absolute;right:18px;top:12px;color:var(--verde);font-weight:700;cursor:pointer}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#111;color:#fff;padding:8px 12px;border-radius:8px;opacity:0;pointer-events:none}
.toast.show{opacity:1;pointer-events:auto}

.modal { 
  display:none; position:fixed; inset:0; 
  background:rgba(0,0,0,0.45); 
  align-items:center; justify-content:center; 
  z-index:1000; 
}
.modal.show { display:flex; }
.modal-card { 
  background:#fff; padding:20px; 
  border-radius:10px; width:90%; 
  max-width:560px; position:relative; 
}
.modal-header { 
  display:flex; justify-content:space-between; 
  align-items:center; margin-bottom:8px;
}
.modal-total { 
  color:#2e8b57; font-weight:bold; font-size:14px;
}
.modal-card .close { 
  position:absolute; right:14px; top:8px; 
  font-size:22px; font-weight:bold; 
  color:#2e8b57; cursor:pointer;
}

.carrinho-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--verde);
  color: white;
  border-radius: 50%;
  width: 56px;
  height: 56px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 22px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  z-index: 999;
  transition: all 0.3s;
}
.carrinho-btn:hover { transform: scale(1.1); }

.carrinho-painel {
  position: fixed;
  right: -400px;
  top: 0;
  width: 350px;
  height: 100%;
  background: #fff;
  box-shadow: -2px 0 8px rgba(0,0,0,0.3);
  transition: right 0.3s;
  z-index: 998;
  display: flex;
  flex-direction: column;
}
.carrinho-painel.show { right: 0; }

.carrinho-header, .carrinho-footer {
  padding: 12px;
  border-bottom: 1px solid #ccc;
}
.carrinho-header { display: flex; justify-content: space-between; align-items: center; }
.carrinho-itens { flex: 1; overflow-y: auto; padding: 10px; }
.carrinho-itens div { margin-bottom: 8px; font-size: 14px; }
.carrinho-footer { border-top: 1px solid #ccc; border-bottom: none; }
.close { background: none; border: none; font-size: 24px; cursor: pointer; }



</style>
</head>
<body>
<header><h1>Cat√°logo Bumerangue</h1></header>

<div class="cats" id="cats"></div>
<div class="subcats" id="subcats"></div>

<!-- tabela de pre√ßo exibida quando Bebidas ativa -->
<div id="priceWrapper" style="display:none;text-align:center;padding:0 12px">
  <table style="max-width:600px">
    <thead><tr><th>Tamanho</th><th>Pre√ßo</th></tr></thead>
    <tbody>
      <tr><td>280ml</td><td>R$ 30</td></tr>
      <tr><td>500ml</td><td>R$ 55</td></tr>
      <tr><td>750ml</td><td>R$ 80</td></tr>
      <tr><td>1L</td><td>R$ 100</td></tr>
    </tbody>
  </table>
</div>

<div class="catalogo" id="catalogo"></div>

<!-- Modal Produto -->
<header><h1>Cat√°logo Bumerangue</h1></header>

<!-- Carrinho Flutuante -->
<div id="carrinho-btn" class="carrinho-btn">
  <i class="fa fa-shopping-cart"></i>
</div>

<!-- Painel do Carrinho -->
<div id="carrinho-painel" class="carrinho-painel">
  <div class="carrinho-header">
    <h3>Seu Carrinho</h3>
    <button id="fechar-carrinho" class="close">&times;</button>
  </div>
  <div id="itens-carrinho" class="carrinho-itens"></div>
  <div class="carrinho-footer">
    <p><strong>Total:</strong> R$ <span id="total-carrinho">0,00</span></p>
    <button id="enviar-pedido">Enviar Pedido</button>
  </div>
</div>
  <div class="modal-card">
    <span class="close" id="closeProduto">√ó</span>
    <div class="modal-header">
      <h2 id="modalNome"></h2>
      <span id="modalTotal" class="modal-total"></span>
    </div>
    <p id="modalDesc" style="color:#666"></p>
    <table>
      <thead>
        <tr>
          <th>Tamanho</th>
          <th>Quantidade</th>
          <th>A√ß√£o</th>
        </tr>
      </thead>
      <tbody id="modalTabela"></tbody>
    </table>
  </div>
</div>



<div class="toast" id="toast"></div>
<footer style="margin-top:36px;padding:12px;text-align:center;color:#fff;background:var(--verde)">&copy; 2025 Bumerangue</footer>

<script>
/* CONFIG */
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw3pMUyN1Q_cHMw__39m4Z9bxhgerQikj8_tOBPaUULgD3WBszDCLfySV-61bLgBKx-1Q/exec"; // substitua ap√≥s publicar
const SHEET_ID = "19c63mlSybEumd2qgRciqTOzuXtCs_5eYEa5jXTylKyQ";
const SUBS_BY_CAT = {
  "Bebidas": ["Releitura dos Cl√°ssicos","Frutas","Sabores Brasileiros"],
  "Doces": ["Doces"],
  "Sabonetes": ["Sabonetes"]
};
const PRECO_POR_TAMANHO = { "280ml":30, "500ml":55, "750ml":80, "1L":100 };

let produtosAtuais = [];
let categoriaAtiva = null;
let subcatAtiva = null;

const catsEl = document.getElementById('cats');
const subcatsEl = document.getElementById('subcats');
const catalogEl = document.getElementById('catalogo');
const priceWrapper = document.getElementById('priceWrapper');
const produtoModal = document.getElementById('produtoModal');
const modalNome = document.getElementById('modalNome');
const modalDesc = document.getElementById('modalDesc');
const modalTabela = document.getElementById('modalTabela');
const modalTotal = document.getElementById('modalTotal');
const toast = document.getElementById('toast');

function showToast(msg, t=1800){
  toast.textContent=msg;
  toast.classList.add('show');
  clearTimeout(window._to);
  window._to=setTimeout(()=>toast.classList.remove('show'),t);
}

/* Categorias principais */
function renderCats(){
  catsEl.innerHTML='';
  Object.keys(SUBS_BY_CAT).forEach((cat, idx)=>{
    const b=document.createElement('button');
    b.textContent=cat;
    b.className='cat-btn';
    b.onclick=()=>selectCat(cat,b);
    catsEl.appendChild(b);
    if(idx===0) setTimeout(()=>b.click(),0);
  });
}

function selectCat(cat, btn){
  document.querySelectorAll('.cat-btn').forEach(x=>x.classList.remove('active'));
  btn.classList.add('active');
  categoriaAtiva = cat;
  priceWrapper.style.display = (cat === 'Bebidas') ? 'block' : 'none';
  const subs = SUBS_BY_CAT[cat] || [];
  subcatsEl.innerHTML='';
  if(subs.length){
    subs.forEach((s,i)=>{
      const sb=document.createElement('button');
      sb.textContent=s;
      sb.className='subcat-btn';
      sb.onclick=()=>selectSubcat(s,sb);
      subcatsEl.appendChild(sb);
      if(i===0) setTimeout(()=>sb.click(),0);
    });
  }else carregarAba(cat);
}

function selectSubcat(sub,btn){
  document.querySelectorAll('.subcat-btn').forEach(x=>x.classList.remove('active'));
  btn.classList.add('active');
  subcatAtiva=sub;
  carregarAba(sub);
}

/* Carrega aba (planilha j√° no novo formato) */
async function carregarAba(sheetName){
  catalogEl.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:40px;color:#666">‚è≥ Carregando...</div>';
  try{
    const url=`https://opensheet.elk.sh/${SHEET_ID}/${encodeURIComponent(sheetName)}`;
    const resp=await fetch(url);
    if(!resp.ok) throw new Error('Erro ao carregar planilha');
    const dados=await resp.json();
    produtosAtuais=(dados||[]).map(d=>({
      nome:d.nome||d.Nome||'Sem nome',
      descricao:d.descricao||d.Descri√ß√£o||'',
      imagem:d.imagem||d.Imagem||'',
      total:Number(d.total||d.Total||0),
      sheet:sheetName
    }));
    renderCatalogo();
  }catch(err){
    console.error(err);
    catalogEl.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:40px;color:#c00">Erro ao carregar.</div>';
  }
}

/* Render cards */
function renderCatalogo(){
  catalogEl.innerHTML='';
  produtosAtuais.forEach(p=>{
    const el=document.createElement('div');
    el.className='produto';
    el.innerHTML=`
      <img src="${p.imagem||'https://via.placeholder.com/400x200?text=Sem+imagem'}"
           alt="" style="width:100%;height:140px;object-fit:cover;border-radius:8px">
      <h3 style="color:var(--verde)">${p.nome}</h3>
      <p style="min-height:36px;color:#666">${p.descricao||''}</p>
      <button class="small" onclick='openModalProduto(${JSON.stringify(p)})'>Ver detalhes</button>
    `;
    catalogEl.appendChild(el);
  });
}

/* Modal produto */
function openModalProduto(prod){
  modalNome.textContent=prod.nome;
  modalDesc.textContent=prod.descricao||'';
  modalTabela.innerHTML='';
  modalTotal.textContent=`Total dispon√≠vel: ${prod.total.toFixed(2)} L`;

  const tamanhos=["280ml","500ml","750ml","1L"];
  tamanhos.forEach(t=>{
    const valorL = t==="1L"?1:parseFloat(t)/1000;
    const preco = PRECO_POR_TAMANHO[t]||0;
    const desabilitar = valorL>prod.total;
    modalTabela.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${t}</td>
        <td><input type="number" id="qtd-${t}" min="1" value="1" step="1" style="width:60px"></td>
        <td>
          <button class="small" ${desabilitar?'disabled':''}
            onclick='engarrafar("${escapeJson(prod.nome)}","${t}",${valorL},"${prod.sheet}",${prod.total})'>
            Adicionar
          </button>
        </td>
      </tr>`);
  });

  produtoModal.classList.add('show');
}

/* Reduz total direto na planilha */
async function engarrafar(nome,label,valorL,sheetName,totalDisponivel){
  const qtd = parseInt(document.getElementById(`qtd-${label}`).value);
  if(isNaN(qtd)||qtd<=0){ showToast('Quantidade inv√°lida'); return; }
  const litros = +(qtd * valorL).toFixed(3);
  if(litros > totalDisponivel){ showToast('Volume insuficiente'); return; }

  // Atualizar diretamente na planilha (sem confirma√ß√£o nem carrinho)
  try {
    const body = { action: "reduce", sheet: sheetName, nome, reduzir_litros: litros };
    const resp = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await resp.json();

    if (data && data.success) {
      showToast(`Novo total: ${data.new_value.toFixed(2)} L`);
      produtoModal.classList.remove('show');
      carregarAba(sheetName);
    } else {
      console.error(data);
      showToast('Erro ao atualizar planilha');
    }
  } catch (err) {
    console.error(err);
    showToast('Erro de conex√£o');
  }
}

/* ==== CARRINHO ==== */
let carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];

const carrinhoBtn = document.getElementById("carrinho-btn");
const carrinhoPainel = document.getElementById("carrinho-painel");
const fecharCarrinho = document.getElementById("fechar-carrinho");
const itensCarrinho = document.getElementById("itens-carrinho");
const totalCarrinho = document.getElementById("total-carrinho");

carrinhoBtn.onclick = () => carrinhoPainel.classList.add("show");
fecharCarrinho.onclick = () => carrinhoPainel.classList.remove("show");

function atualizarCarrinho() {
  itensCarrinho.innerHTML = "";
  let total = 0;
  carrinho.forEach((item, i) => {
    const div = document.createElement("div");
    const preco = (PRECO_POR_TAMANHO[item.tamanho] || 0) * item.qtd;
    total += preco;
    div.innerHTML = `
      ${item.nome} (${item.tamanho}) ‚Äî ${item.qtd}x = R$ ${preco.toFixed(2)}
      <button onclick="removerItem(${i})">üóëÔ∏è</button>
    `;
    itensCarrinho.appendChild(div);
  });
  totalCarrinho.textContent = total.toFixed(2);
  localStorage.setItem("carrinho", JSON.stringify(carrinho));
}

function removerItem(i) {
  carrinho.splice(i, 1);
  atualizarCarrinho();
}

function adicionarAoCarrinho(produto, tamanho, qtd) {
  const existente = carrinho.find(
    p => p.nome === produto.nome && p.tamanho === tamanho
  );
  if (existente) existente.qtd += qtd;
  else carrinho.push({ nome: produto.nome, tamanho, qtd });
  atualizarCarrinho();
  showToast("Adicionado ao carrinho");
}

/* Modificar fun√ß√£o engarrafar */
async function engarrafar(nome,label,valorL,sheetName,totalDisponivel){
  const qtd=parseInt(document.getElementById(`qtd-${label}`).value);
  if(isNaN(qtd)||qtd<=0){ showToast('Quantidade inv√°lida'); return; }
  const litros=qtd*valorL;
  if(litros>totalDisponivel){ showToast('Volume insuficiente'); return; }

  adicionarAoCarrinho({ nome, sheet: sheetName }, label, qtd);

  // Atualizar na planilha
  try {
    const body={action:"reduce",sheet:sheetName,nome, reduzir_litros:litros};
    const r=await fetch(APPS_SCRIPT_URL,{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    const d=await r.json();
    if(d && d.success){
      produtoModal.classList.remove('show');
      carregarAba(sheetName);
    }
  } catch(err) {
    console.error(err);
    showToast('Erro de conex√£o');
  }
}

atualizarCarrinho();






/* utilidades */
function escapeJson(s){return String(s).replace(/"/g,'\\"').replace(/'/g,"\\'");}
document.getElementById('closeProduto').onclick=()=>produtoModal.classList.remove('show');
produtoModal.onclick=e=>{if(e.target===produtoModal)produtoModal.classList.remove('show');};

renderCats();

</script>
</body>
</html>
