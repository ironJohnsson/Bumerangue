<!doctype html>
<html lang="pt-BR">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Catálogo</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--verde:#2e8b57;--fundo:#fffaf0}
body{font-family:Roboto, sans-serif;background:var(--fundo);color:#222;margin:0}
header,footer{background:var(--verde);color:#fff;padding:12px;text-align:center}
.cats{display:flex;gap:8px;justify-content:center;padding:18px}
.cat-btn{padding:8px 12px;border:2px solid var(--verde);background:#fff;color:var(--verde);border-radius:8px;cursor:pointer}
.cat-btn.active{background:var(--verde);color:#fff}
.subcats{display:flex;gap:8px;justify-content:center;margin-bottom:12px}
.subcat-btn{padding:6px 10px;border-radius:8px;border:2px solid var(--verde);background:#fff;color:var(--verde);cursor:pointer}
.catalogo{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px;padding:12px}
.produto{background:#fff;border-radius:10px;padding:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);text-align:center}
button.small{padding:6px 10px;border-radius:8px;background:var(--verde);color:#fff;border:none;cursor:pointer}
table{width:100%;border-collapse:collapse;margin:12px auto}
th,td{padding:8px;border:1px solid #ddd;text-align:center}
th{background:var(--verde);color:#fff}
.modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);align-items:center;justify-content:center}
.modal.show{display:flex}
.modal-card{background:#fff;padding:18px;border-radius:10px;width:92%;max-width:560px}
.close{position:absolute;right:18px;top:12px;color:var(--verde);font-weight:700;cursor:pointer}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#111;color:#fff;padding:8px 12px;border-radius:8px;opacity:0;pointer-events:none}
.toast.show{opacity:1;pointer-events:auto}
</style>
</head>
<body>
<header><h1>Catálogo Bumerangue</h1></header>

<div class="cats" id="cats"></div>
<div class="subcats" id="subcats"></div>

<!-- tabela de preço exibida quando Bebidas ativa -->
<div id="priceWrapper" style="display:none;text-align:center;padding:0 12px">
  <table style="max-width:600px">
    <thead><tr><th>Tamanho</th><th>Preço</th></tr></thead>
    <tbody>
      <tr><td>280ml</td><td>R$ 30</td></tr>
      <tr><td>500ml</td><td>R$ 55</td></tr>
      <tr><td>750ml</td><td>R$ 80</td></tr>
      <tr><td>1L</td><td>R$ 100</td></tr>
    </tbody>
  </table>
</div>

<div class="catalogo" id="catalogo"></div>

<!-- Modal Produto -->
<div id="produtoModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <span class="close" id="closeProduto">×</span>
    <h2 id="modalNome"></h2>
    <p id="modalDesc" style="color:#666"></p>
    <table>
      <thead><tr><th>Tamanho</th><th> — </th></tr></thead>
      <tbody id="modalTabela"></tbody>
    </table>
  </div>
</div>

<div class="toast" id="toast"></div>
<footer style="margin-top:36px;padding:12px;text-align:center;color:#fff;background:var(--verde)">&copy; 2025 Bumerangue</footer>

<script>
/* CONFIG: substitua pelo URL do seu Apps Script após deploy */
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw3pMUyN1Q_cHMw__39m4Z9bxhgerQikj8_tOBPaUULgD3WBszDCLfySV-61bLgBKx-1Q/exec"; // <<-- substitua
const SHEET_ID = "19c63mlSybEumd2qgRciqTOzuXtCs_5eYEa5jXTylKyQ"; // opcional, usado pelo opensheet
const SUBS_BY_CAT = {
  "Bebidas": ["Releitura dos Clássicos","Frutas","Sabores Brasileiros"],
  "Doces": ["Doces"],
  "Sabonetes": ["Sabonetes"]
};
const PRECO_POR_TAMANHO = { "280ml":30, "500ml":55, "750ml":80, "1L":100 };

/* estado */
let produtosAtuais = []; // carregados da aba
let categoriaAtiva = null;
let subcatAtiva = null;

/* refs */
const catsEl = document.getElementById('cats');
const subcatsEl = document.getElementById('subcats');
const catalogEl = document.getElementById('catalogo');
const priceWrapper = document.getElementById('priceWrapper');
const produtoModal = document.getElementById('produtoModal');
const modalNome = document.getElementById('modalNome');
const modalDesc = document.getElementById('modalDesc');
const modalTabela = document.getElementById('modalTabela');
const toast = document.getElementById('toast');

function showToast(msg, t=1800){toast.textContent=msg;toast.classList.add('show');clearTimeout(window._to);window._to=setTimeout(()=>toast.classList.remove('show'),t);}

/* Render categorias principais */
function renderCats(){
  catsEl.innerHTML='';
  Object.keys(SUBS_BY_CAT).forEach((cat, idx) => {
    const b=document.createElement('button'); b.textContent=cat; b.className='cat-btn';
    b.onclick = ()=> { selectCat(cat, b); };
    catsEl.appendChild(b);
    if(idx===0) setTimeout(()=>b.click(),0);
  });
}

function selectCat(cat, btn){
  document.querySelectorAll('.cat-btn').forEach(x=>x.classList.remove('active'));
  btn.classList.add('active');
  categoriaAtiva = cat;
  // price table visible only for Bebidas
  priceWrapper.style.display = (cat === 'Bebidas') ? 'block' : 'none';
  // render subcats (if exists)
  const subs = SUBS_BY_CAT[cat] || [];
  subcatsEl.innerHTML = '';
  if(subs.length){
    subs.forEach((s, i)=>{
      const sb=document.createElement('button'); sb.textContent=s; sb.className='subcat-btn';
      sb.onclick = ()=> { selectSubcat(s, sb); };
      subcatsEl.appendChild(sb);
      if(i===0) setTimeout(()=>sb.click(),0);
    });
  } else {
    carregarAba(cat);
  }
}

function selectSubcat(sub, btn){
  document.querySelectorAll('.subcat-btn').forEach(x=>x.classList.remove('active'));
  btn.classList.add('active');
  subcatAtiva = sub;
  carregarAba(sub);
}

/* Carrega a aba via opensheet.elk.sh (read-only) */
async function carregarAba(sheetName){
  catalogEl.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#666">⏳ Carregando...</div>';
  try{
    const url = `https://opensheet.elk.sh/${SHEET_ID}/${encodeURIComponent(sheetName)}`;
    const resp = await fetch(url);
    if(!resp.ok) throw new Error('Erro ao carregar planilha');
    const dados = await resp.json();
    // normalizar
    produtosAtuais = (dados||[]).map(d => {
      return {
        _raw: d,
        nome: d.Nome||d.nome||d.Produto||d.produto||'Sem nome',
        descricao: d.Descricao||d.descricao||'',
        imagem: d.Imagem||d.imagem||'',
        '280ml': Number(d['280ml']||d['280']||0),
        '500ml': Number(d['500ml']||d['500']||0),
        '750ml': Number(d['750ml']||d['750']||0),
        '1L': Number(d['1L']||d['1l']||d['1000ml']||0),
        'nao_engarrafado': Number(d['nao_engarrafado']||d['Não engarrafado']||d['nao engarrafado']||0),
        sheet: sheetName
      };
    });
    renderCatalogo();
  }catch(err){
    console.error(err);
    catalogEl.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#c00">Erro ao carregar.</div>';
  }
}

/* Renderiza cards (usando apenas nao_engarrafado como quantidade total) */
function renderCatalogo(){
  catalogEl.innerHTML = '';
  produtosAtuais.forEach(p => {
    const el = document.createElement('div'); el.className='produto';
    el.innerHTML = `
      <img src="${p.imagem||'https://via.placeholder.com/400x200?text=Sem+imagem'}" alt="" style="width:100%;height:140px;object-fit:cover;border-radius:8px">
      <h3 style="color:var(--verde)">${p.nome}</h3>
      <p style="min-height:36px;color:#666">${p.descricao||''}</p>
    `;
    const btn = document.createElement('button'); btn.className='small'; btn.textContent='Ver detalhes';
    btn.onclick = ()=> openModalProduto(p);
    el.appendChild(btn);
    catalogEl.appendChild(el);
  });
}

/* Modal: mostra apenas uma tabela com tamanhos e o controle "não engarrafado" que representa o total */
function openModalProduto(prod){
  modalNome.textContent = prod.nome;
  modalDesc.textContent = prod.descricao || '';
  modalTabela.innerHTML = '';

  // tabela com os tamanhos (apenas rótulo — disponibilidade removida)
  const tamanhos = ["280ml","500ml","750ml","1L"];
  tamanhos.forEach(t => {
    modalTabela.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${t}</td>
        <td>
          <button class="small" onclick='engarrafarPadrao("${escapeJson(prod.nome)}","${t}", "${prod.sheet}")'>Usar ${t}</button>
        </td>
      </tr>
    `);
  });

  // bloco NAO ENGARRAFADO (quantidade total)
  const totalLitros = Number(prod['nao_engarrafado'] || 0);
  modalTabela.insertAdjacentHTML('beforeend', `
    <tr>
      <td colspan="2" style="text-align:left;padding:10px">
        <strong>Não engarrafado:</strong> ${totalLitros.toFixed(2)} L disponíveis
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="small" data-tam="0.28" onclick='prepararNaoEng("${escapeJson(prod.nome)}",0.28,"${prod.sheet}", ${totalLitros})'>280ml</button>
          <button class="small" data-tam="0.5" onclick='prepararNaoEng("${escapeJson(prod.nome)}",0.5,"${prod.sheet}", ${totalLitros})'>500ml</button>
          <button class="small" data-tam="0.75" onclick='prepararNaoEng("${escapeJson(prod.nome)}",0.75,"${prod.sheet}", ${totalLitros})'>750ml</button>
          <button class="small" data-tam="1" onclick='prepararNaoEng("${escapeJson(prod.nome)}",1,"${prod.sheet}", ${totalLitros})'>1L</button>
        </div>
      </td>
    </tr>
  `);

  produtoModal.classList.add('show');
}

/* escapador simples para strings com aspas no HTML inlined */
function escapeJson(s){
  return String(s).replace(/"/g,'\\"').replace(/'/g,"\\'");
}

/* Engarrafar usando o estoque total: chama o Apps Script para reduzir o valor na planilha */
async function prepararNaoEng(nome, litros, sheetName, totalDisponivel){
  // perguntar quantas garrafas
  let qtd = prompt(`Quantidade de garrafas de ${formatLitros(litros)} que deseja (disponível ${totalDisponivel} L)?`, "1");
  if(!qtd) return;
  qtd = parseInt(qtd);
  if(isNaN(qtd) || qtd <= 0){ showToast('Quantidade inválida'); return; }
  const totalLitros = +(qtd * litros).toFixed(3);
  if(totalLitros > totalDisponivel){ showToast('Volume insuficiente'); return; }

  // confirmar
  if(!confirm(`Adicionar ${qtd} x ${formatLitros(litros)} (${totalLitros} L) ao carrinho?`)) return;

  // calcular preco por unidade
  const precoUnit = PRECO_POR_TAMANHO[convertLabel(litros)] || 0;
  for(let i=0;i<qtd;i++){
    // adicionar ao carrinho localmente (para UX rápida)
    const nomeItem = nome + ` (${formatLitros(litros)})`;
    const preco = precoUnit;
    adicionarAoCarrinhoLocal(nomeItem, formatLabel(litros), preco);
  }

  // chamar Apps Script para reduzir o valor na planilha
  try{
    const body = { action: "reduce", sheet: sheetName, nome: nome, reduzir_litros: totalLitros };
    const resp = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await resp.json();
    if(data && data.success){
      showToast('Estoque atualizado na planilha');
      // recarregar aba para atualizar UI
      carregarAba(sheetName);
      produtoModal.classList.remove('show');
    } else {
      console.error(data);
      showToast('Erro ao atualizar planilha');
    }
  }catch(err){ console.error(err); showToast('Erro ao conectar ao Apps Script'); }
}

/* Engarrafar padrão (usar a unidade já engarrafada se existir) — agora removemos disponibilidade,
   então vamos redirecionar o usuário para usar o bloco "Não engarrafado" (porque a única fonte de verdade é total)
*/
function engarrafarPadrao(nome, label, sheetName){
  showToast('Use o bloco "Não engarrafado" para gerenciar estoque total (engarrafado + não engarrafado).');
}

/* utilidade: converte valor (0.28) para label (280ml) */
function convertLabel(valor){
  if(valor === 0.28) return '280ml';
  if(valor === 0.5) return '500ml';
  if(valor === 0.75) return '750ml';
  if(valor === 1) return '1L';
  return `${valor}L`;
}
function formatLabel(valor){
  return convertLabel(valor);
}
function formatLitros(valor){
  if(valor >= 1) return `${valor} L`;
  return `${Math.round(valor*1000)} ml`;
}

/* adiciona ao carrinho local (apenas localStorage e UX) */
function adicionarAoCarrinhoLocal(nome, tamanho, preco){
  const carrinho = JSON.parse(localStorage.getItem('carrinhoBumerangue')||'[]');
  carrinho.push({ nome, tamanho, preco });
  localStorage.setItem('carrinhoBumerangue', JSON.stringify(carrinho));
}

/* modal close */
document.getElementById('closeProduto').onclick = ()=> produtoModal.classList.remove('show');

/* init */
renderCats();
</script>
</body>
</html>
