<section id="catalogo" class="text-center py-8">
  <h2 class="text-2xl font-bold text-green-700 mb-6">Nossas Bebidas e Produtos</h2>

  <!-- üîπ Tabela de pre√ßos (somente para BEBIDAS) -->
  <div id="tabela-precos" class="tabela-precos mb-8">
    <table class="mx-auto shadow rounded-lg">
      <thead>
        <tr>
          <th>Tamanho</th>
          <th>Pre√ßo</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>280ml</td><td>R$ 30,00</td></tr>
        <tr><td>500ml</td><td>R$ 55,00</td></tr>
        <tr><td>750ml</td><td>R$ 80,00</td></tr>
        <tr><td>1L</td><td>R$ 100,00</td></tr>
      </tbody>
    </table>
  </div>

  <!-- üîπ Bot√µes de categoria -->
  <div class="mb-6 flex justify-center flex-wrap gap-3">
    <button class="categoria-btn" data-categoria="todas"> Todas</button>
    <button class="categoria-btn" data-categoria="bebidas"> Bebidas</button>
    <button class="categoria-btn" data-categoria="doces"> Doces</button>
    <button class="categoria-btn" data-categoria="sabonetes"> Sabonetes</button>
  </div>

  <!-- üîπ Subcategorias de BEBIDAS -->
  <div id="subcategorias" class="mb-6 hidden flex justify-center flex-wrap gap-3">
    <button class="sub-btn" data-sub="releituras">Releitura dos Cl√°ssicos</button>
    <button class="sub-btn" data-sub="frutas">Frutas</button>
    <button class="sub-btn" data-sub="sabores-brasileiros">Sabores Brasileiros</button>
  </div>

  <!-- üîπ √Årea de produtos -->
  <div id="produtos" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 px-4">
    <!-- JS insere produtos da planilha -->
  </div>
</section>

<script>
const SHEET_ID = "19c63mlSybEumd2qgRciqTOzuXtCs_5eYEa5jXTylKyQ";
const precosPorTamanho = { "280ml": 30, "500ml": 55, "750ml": 80, "1L": 100 };
let carrinho = [];

const tabelaPrecos = document.getElementById("tabela-precos");
const subcategorias = document.getElementById("subcategorias");
const botoesCategoria = document.querySelectorAll(".categoria-btn");
const produtosContainer = document.getElementById("produtos");

botoesCategoria.forEach(btn => {
  btn.addEventListener("click", () => {
    const cat = btn.dataset.categoria;

    if (cat === "bebidas") {
      tabelaPrecos.style.display = "block";
      subcategorias.classList.remove("hidden");
      carregarAba("Bebidas");
    } else if (cat === "todas") {
      tabelaPrecos.style.display = "none";
      subcategorias.classList.add("hidden");
      carregarTodas();
    } else {
      tabelaPrecos.style.display = "none";
      subcategorias.classList.add("hidden");
      carregarAba(cat.charAt(0).toUpperCase() + cat.slice(1));
    }
  });
});

// Subcategorias de bebidas
document.querySelectorAll(".sub-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    carregarAba(btn.dataset.sub.replace("-", " "));
  });
});

// === Fun√ß√µes de carregamento ===
async function carregarAba(aba) {
  produtosContainer.innerHTML = `<p class='col-span-3 text-center text-gray-500'>‚è≥ Carregando ${aba}...</p>`;
  const url = `https://opensheet.elk.sh/${SHEET_ID}/${encodeURIComponent(aba)}`;
  try {
    const resp = await fetch(url);
    const dados = await resp.json();
    renderCatalogo(dados, aba);
  } catch {
    produtosContainer.innerHTML = `<p class='text-red-600 text-center'>Erro ao carregar ${aba}</p>`;
  }
}

async function carregarTodas() {
  produtosContainer.innerHTML = `<p class='text-center text-gray-500'>‚è≥ Carregando todos os produtos...</p>`;
  const abas = ["Releitura dos Cl√°ssicos", "Frutas", "Sabores Brasileiros", "Doces", "Sabonetes"];
  const todas = [];
  for (const aba of abas) {
    try {
      const resp = await fetch(`https://opensheet.elk.sh/${SHEET_ID}/${encodeURIComponent(aba)}`);
      const dados = await resp.json();
      todas.push(...dados.map(d => ({ ...d, aba })));
    } catch {}
  }
  renderCatalogo(todas, "Todas");
}

function renderCatalogo(dados, aba) {
  produtosContainer.innerHTML = "";
  const bebidas = ["Releitura dos Cl√°ssicos", "Frutas", "Sabores Brasileiros"].includes(aba);

  dados.forEach(p => {
    const div = document.createElement("div");
    div.className = "produto-item border rounded-lg shadow p-4 bg-white";
    div.dataset.categoria = aba.toLowerCase();

    const estoqueOk = bebidas
      ? Object.values(precosPorTamanho).some(v => v > 0)
      : (parseInt(p.estoque) || 0) > 0;

    div.innerHTML = `
      <img src="${p.imagem || 'https://via.placeholder.com/400x200'}" class="w-full h-48 object-cover rounded mb-3">
      <h3 class="text-green-700 font-bold text-lg">${p.nome}</h3>
      <p class="text-sm text-gray-600 mb-2">${p.descricao || ""}</p>
      ${bebidas
        ? `<p class="text-gray-700 text-sm mb-2">Selecione o tamanho abaixo:</p>
           <select id="selectTamanho-${p.nome}" class="border rounded px-2 py-1 mb-3">
             ${Object.keys(precosPorTamanho)
               .map(t => `<option value="${t}">${t} - R$${precosPorTamanho[t]},00</option>`)
               .join("")}
           </select>`
        : `<p><strong>Pre√ßo:</strong> R$ ${p.preco || "-"}</p>`
      }
      <button class="add-carrinho mt-2 px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700"
        ${estoqueOk ? "" : "disabled"}
        data-nome="${p.nome}"
        data-aba="${aba}">
        ${estoqueOk ? "üõí Adicionar ao Carrinho" : "‚ùå Indispon√≠vel"}
      </button>
    `;
    produtosContainer.appendChild(div);
  });

  document.querySelectorAll(".add-carrinho").forEach(btn => {
    btn.addEventListener("click", () => {
      const nome = btn.dataset.nome;
      const abaProduto = btn.dataset.aba;
      const tamanhoSel = document.getElementById(`selectTamanho-${nome}`);
      const tamanho = tamanhoSel ? tamanhoSel.value : "";
      const preco = tamanho ? precosPorTamanho[tamanho] : parseFloat(btn.dataset.preco) || 0;
      const item = { nome, tamanho, preco, email: "" };
      carrinho.push(item);
      showToast(`${nome} adicionado ao carrinho`);
    });
  });
}

// === Toast de confirma√ß√£o ===
function showToast(msg) {
  const toast = document.createElement("div");
  toast.textContent = msg;
  toast.className =
    "fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-black text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300";
  document.body.appendChild(toast);
  setTimeout(() => (toast.style.opacity = 1), 50);
  setTimeout(() => {
    toast.style.opacity = 0;
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// === Carrinho e envio via App Script ===
async function enviarPedido() {
  const EMAIL_SCRIPT_URL = "https://script.google.com/u/0/home/projects/10rQQX5O0AFMHb9QgpXZd7MHr6BS7OlwR0fJB1KAds_qAptRc0VjbV8TU/edit";
  if (carrinho.length === 0) return alert("Carrinho vazio!");

  try {
    const resp = await fetch(EMAIL_SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify(carrinho),
      headers: { "Content-Type": "application/json" }
    });
    const txt = await resp.text();
    alert(txt.includes("sucesso") ? "Pedido enviado com sucesso!" : "Erro ao enviar pedido.");
  } catch (err) {
    alert("Erro ao enviar pedido: " + err);
  }
}
</script>