<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cat√°logo - Bumerangue</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{--verde:#2e8b57;--verde-esc:#256b46;--fundo:#fffaf0;--card:#f8f8f8}
  *{box-sizing:border-box}
  body{font-family:"Roboto",sans-serif;background:var(--fundo);color:#333;margin:0}
  header,footer{background:var(--verde);color:#fff;padding:15px;text-align:center}
  nav a{margin:0 15px;color:#fff;text-decoration:none;font-weight:700;cursor:pointer}
  nav a:hover, nav a.active{color:#ffeb3b}
  .catalogo{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;padding:30px}
  @media(max-width:900px){.catalogo{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:600px){.catalogo{grid-template-columns:1fr}}
  .produto{background:var(--card);border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1);overflow:hidden;text-align:center;transition:transform .18s;cursor:pointer}
  .produto:hover{transform:scale(1.03)}
  .produto img{width:100%;height:200px;object-fit:cover}
  .produto h3{color:var(--verde);margin:10px 0}
  .produto p{padding:0 10px 15px;color:#666}
  #tabelaPrecos{max-width:600px;margin:30px auto;background:var(--card);border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1);padding:15px}
  #tabelaPrecos h3{color:var(--verde);text-align:center;margin-bottom:10px}
  .modal{display:none;position:fixed;z-index:1100;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);align-items:center;justify-content:center;padding:20px}
  .modal.show{display:flex}
  .modal-card{background:#fff;border-radius:12px;padding:20px;max-width:520px;width:100%;box-shadow:0 12px 30px rgba(0,0,0,.25);position:relative}
  .modal-sm{max-width:420px}
  .close{position:absolute;right:14px;top:10px;font-size:20px;color:var(--verde);cursor:pointer;font-weight:700}
  .close:hover{color:var(--verde-esc)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;text-align:center;border-bottom:1px solid #eee;vertical-align:middle}
  th{background:var(--verde);color:#fff}
  .status-indisponivel{color:red;font-weight:700}
  .status-disponivel{color:green;font-weight:700}
  button{background:var(--verde);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  button.ghost{background:transparent;color:var(--verde);border:2px solid var(--verde)}
  button.small{padding:6px 8px;font-size:.9rem;border-radius:6px}
  button.danger{background:#e04b4b}
  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .right{display:flex;justify-content:flex-end}
  #carrinhoBtn{position:fixed;right:20px;bottom:20px;background:var(--verde);color:#fff;border-radius:50%;width:60px;height:60px;border:none;font-size:22px;box-shadow:0 8px 20px rgba(0,0,0,.25);cursor:pointer}
  .sizes{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  .size-btn{padding:10px 14px;border-radius:10px;border:2px solid rgba(0,0,0,.06);cursor:pointer;background:#fff;font-weight:700;color:#000;transition:all .2s ease}
  .size-btn:hover:not(:disabled):not(.selected){background:#f0f0f0}
  .size-btn.selected{background:var(--verde);color:#fff;border-color:var(--verde)}
  .size-btn.selected:hover{background:#3fa76a}
  .size-btn:disabled{opacity:0.5;cursor:not-allowed;color:#666}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:32px;background:#111;color:#fff;padding:12px 18px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.3);z-index:1200;opacity:0;pointer-events:none;transition:opacity .2s,transform .2s}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px);pointer-events:auto}
  #itensCarrinho p{margin:8px 0;padding:8px;border-radius:8px;background:#fafafa;border:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
  #itensCarrinho .item-left{display:flex;flex-direction:column;align-items:flex-start;gap:4px}
  .small-muted{font-size:.9rem;color:#666}
  .subcats{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:16px}
  .subcat-btn{padding:8px 10px;border-radius:8px;border:2px solid var(--verde);background:#fff;color:var(--verde);cursor:pointer;font-weight:700}
  .subcat-btn.active{background:var(--verde);color:#fff}
  .catalogo-empty{text-align:center;padding:40px;color:#666}
</style>
</head>
<body>
<header>
  <h1>Cat√°logo Bumerangue</h1>
  <nav>
    <a id="navInicio">In√≠cio</a>
    <a id="navCatalogo" class="active">Cat√°logo</a>
    <a id="navSobre">Sobre</a>
    <a id="navContato">Contato</a>
  </nav>
</header>

<main>
  <!-- In√≠cio / Sobre / Contato simples (abismo de navega√ß√£o) -->
  <section id="secInicio" style="display:none;padding:30px;text-align:center">
    <h2>Bem-vindo</h2>
    <p>Explore nossos produtos artesanais.</p>
  </section>
  <section id="secSobre" style="display:none;padding:30px;text-align:center">
    <h2>Sobre</h2><p>Bumerangue - Bebidas Artesanais</p>
  </section>
  <section id="secContato" style="display:none;padding:30px;text-align:center">
    <h2>Contato</h2><p>contato@bumerangue.com</p>
  </section>

  <!-- √Årea principal do cat√°logo (mant√©m layout que voc√™ mandou) -->
  <section id="secCatalogo" style="display:block">
    <h2 style="text-align:center;margin:20px 0;color:var(--verde)">Nossas Bebidas e Produtos</h2>

    <div id="tabelaPrecos">
      <h3>Tabela de Pre√ßos (padr√£o para todos os sabores)</h3>
      <table>
        <thead><tr><th>Tamanho</th><th>Pre√ßo</th></tr></thead>
        <tbody>
          <tr><td>280ml</td><td>R$ 30,00</td></tr>
          <tr><td>500ml</td><td>R$ 55,00</td></tr>
          <tr><td>750ml</td><td>R$ 80,00</td></tr>
          <tr><td>1L</td><td>R$ 100,00</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Categorias principais -->
    <div style="display:flex;gap:12px;justify-content:center;margin:18px 0">
      <button class="subcat-btn" data-cat="Bebidas">üç∏ Bebidas</button>
      <button class="subcat-btn" data-cat="Doces">üç¨ Doces</button>
      <button class="subcat-btn" data-cat="Sabonetes">üßº Sabonetes</button>
    </div>

    <!-- Subcategorias din√¢micas -->
    <div id="subcatsContainer" class="subcats"></div>

    <div class="catalogo" id="catalogo"></div>

  </section>
</main>

<footer>
  <p>&copy; 2025 Bumerangue - Bebidas Artesanais</p>
</footer>

<!-- Modal produto -->
<div id="produtoModal" class="modal" aria-hidden="true">
  <div class="modal-card modal-sm" role="dialog" aria-modal="true">
    <span class="close" id="closeProduto">&times;</span>
    <h2 id="modalNome">Produto</h2>
    <table>
      <thead><tr><th>Tamanho</th><th>Qtde</th><th>A√ß√£o</th></tr></thead>
      <tbody id="modalTabela"></tbody>
    </table>
  </div>
</div>

<!-- Modal tamanho (para 'N√£o engarrafado') -->
<div id="sizeSelectModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true">
    <span class="close" id="closeSize">&times;</span>
    <h3 id="sizeTitle">Escolha o tamanho</h3>
    <p class="small-muted" id="sizeInfo">Selecione o tamanho da garrafa</p>
    <div class="sizes" id="sizeButtons">
      <button class="size-btn" data-size="280ml">280ml</button>
      <button class="size-btn" data-size="500ml">500ml</button>
      <button class="size-btn" data-size="750ml">750ml</button>
      <button class="size-btn" data-size="1L">1L</button>
    </div>
    <div style="margin-top:16px;display:flex;gap:8px;justify-content:center">
      <button id="confirmSize" class="small">Adicionar</button>
      <button id="cancelSize" class="ghost small">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal carrinho -->
<div id="carrinhoModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true">
    <span class="close" id="closeCarrinho">&times;</span>
    <h2>Seu Carrinho</h2>
    <div id="itensCarrinho"></div>
    <p id="totalCarrinho" style="font-weight:700;margin-top:10px"></p>

    <label style="display:block;margin-top:8px">Seu e-mail</label>
    <input id="emailCliente" type="email" placeholder="seu@email.com" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ddd">

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="finalizarPedido" style="flex:1">Finalizar pedido (enviar)</button>
      <button id="limparCarrinho" class="ghost" style="flex:1">Limpar</button>
    </div>

    <div style="text-align:center;margin-top:12px">
      <p class="small-muted">QR Code para pagamento (valor total)</p>
      <img id="qrPreview" width="200" height="200" alt="QR Code" style="display:block;margin:0 auto">
    </div>
  </div>
</div>

<button id="carrinhoBtn" title="Ver carrinho">üõí</button>
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ==================== CONFIG ==================== */
/* 1) URL da sua planilha p√∫blica: usaremos opensheet.elk.sh por folha (sheet name). */
const SHEET_ID = "19c63mlSybEumd2qgRciqTOzuXtCs_5eYEa5jXTylKyQ";

/* 2) Nome das abas (sheets) dentro da planilha.
   Ajuste se seus nomes forem diferentes. */
const SUBS_BY_CAT = {
  "Bebidas": ["Releitura dos Cl√°ssicos","Frutas","Sabores Brasileiros"],
  "Doces": ["Doces"],
  "Sabonetes": ["Sabonetes"]
};

/* 3) Pre√ßos padr√£o por tamanho (mesmos do seu script) */
const PRECO_POR_TAMANHO = { "280ml":30, "500ml":55, "750ml":80, "1L":100 };

/* 4) Endpoint do seu Apps Script (substitua pelo URL do deploy web app) */
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwIjG3LEZt_xi0U8Wj0x0C_H-8rkb92nIkXA6uNpBiydGj-aQ4ro4N9BTtQfW42Czi_Ng/exec"; // <<-- troque aqui

/* ==================== Estado local ==================== */
let produtosAtuais = []; // lista de objetos atuais carregados (por aba atual)
let carrinho = JSON.parse(localStorage.getItem("carrinhoBumerangue")) || [];
let sizeContext = null; // { index, tipo } quando selecionando tamanho 'N√£o engarrafado'

/* ==================== UI refs ==================== */
const catalogoDiv = document.getElementById('catalogo');
const subcatsContainer = document.getElementById('subcatsContainer');
const toastEl = document.getElementById('toast');
const produtoModal = document.getElementById('produtoModal');
const modalNome = document.getElementById('modalNome');
const modalTabela = document.getElementById('modalTabela');
const sizeModal = document.getElementById('sizeSelectModal');
const sizeTitle = document.getElementById('sizeTitle');
const sizeInfo = document.getElementById('sizeInfo');
const sizeButtons = document.getElementById('sizeButtons');
const confirmSizeBtn = document.getElementById('confirmSize');
const cancelSizeBtn = document.getElementById('cancelSize');
const carrinhoBtn = document.getElementById('carrinhoBtn');
const carrinhoModal = document.getElementById('carrinhoModal');
const itensCarrinhoDiv = document.getElementById('itensCarrinho');
const totalCarrinhoP = document.getElementById('totalCarrinho');
const emailClienteInput = document.getElementById('emailCliente');
const qrPreview = document.getElementById('qrPreview');

/* abas nav */
document.getElementById('navInicio').addEventListener('click', ()=>showSection('secInicio'));
document.getElementById('navCatalogo').addEventListener('click', ()=>showSection('secCatalogo'));
document.getElementById('navSobre').addEventListener('click', ()=>showSection('secSobre'));
document.getElementById('navContato').addEventListener('click', ()=>showSection('secContato'));

function showSection(id){
  ['secInicio','secCatalogo','secSobre','secContato'].forEach(s=>document.getElementById(s).style.display = s===id ? (s==='secCatalogo' ? 'block' : 'block') : 'none');
  // toggle nav active
  document.querySelectorAll('nav a').forEach(a=>a.classList.remove('active'));
  if(id==='secCatalogo') document.getElementById('navCatalogo').classList.add('active');
  if(id==='secInicio') document.getElementById('navInicio').classList.add('active');
  if(id==='secSobre') document.getElementById('navSobre').classList.add('active');
  if(id==='secContato') document.getElementById('navContato').classList.add('active');
}

/* ==================== toasts / storage ==================== */
function showToast(msg, t=2500){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  clearTimeout(window._toastTimer);
  window._toastTimer = setTimeout(()=> toastEl.classList.remove('show'), t);
}
function salvarCarrinho(){
  localStorage.setItem('carrinhoBumerangue', JSON.stringify(carrinho));
}

/* ==================== Categorias & Subcategorias ==================== */
function renderCategoriaBtns(){
  subcatsContainer.innerHTML = '';
  // ao entrar, por padr√£o selecionar Bebidas
  const firstCat = Object.keys(SUBS_BY_CAT)[0];
  Object.entries(SUBS_BY_CAT).forEach(([cat, subs])=>{
    const catBtn = document.createElement('button');
    catBtn.className = 'subcat-btn';
    catBtn.textContent = cat;
    catBtn.dataset.cat = cat;
    catBtn.addEventListener('click', ()=> {
      // highlight
      document.querySelectorAll('.subcat-btn').forEach(b=>b.classList.remove('active'));
      catBtn.classList.add('active');
      renderSubcats(cat);
    });
    subcatsContainer.appendChild(catBtn);
    // auto-click first cat
    if(cat === firstCat) catBtn.click();
  });
}

function renderSubcats(cat){
  const subs = SUBS_BY_CAT[cat] || [];
  // render sub-buttons
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.gap = '8px';
  container.style.justifyContent = 'center';
  container.style.marginBottom = '12px';
  subcatsContainer.innerHTML = '';
  subs.forEach((s, idx) => {
    const b = document.createElement('button');
    b.className = 'subcat-btn';
    b.textContent = s;
    b.dataset.sheet = s;
    b.addEventListener('click', ()=> {
      // toggle active
      subcatsContainer.querySelectorAll('.subcat-btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      carregarAba(s, cat);
    });
    subcatsContainer.appendChild(b);
    if(idx===0) b.click();
  });
}

/* ==================== carregar planilha (opensheet.elk.sh) ==================== */
async function carregarAba(sheetName, categoria){
  catalogoDiv.innerHTML = `<div class="catalogo-empty">‚è≥ Carregando ${sheetName}...</div>`;
  const url = `https://opensheet.elk.sh/${SHEET_ID}/${encodeURIComponent(sheetName)}`;
  try{
    const resp = await fetch(url);
    if(!resp.ok) throw new Error("Erro ao buscar planilha");
    const dados = await resp.json();
    // dados √© array de objetos por linha
    produtosAtuais = dados.map(d=>normalizeRow(d));
    renderCatalogo(categoria, sheetName);
  }catch(err){
    console.error(err);
    catalogoDiv.innerHTML = `<div class="catalogo-empty">Erro ao carregar "${sheetName}". Verifique se a aba existe e est√° p√∫blica.</div>`;
  }
}

/* normaliza chaves/nomes esperados da planilha */
function normalizeRow(d){
  // campos esperados: nome, descricao, imagem, 280ml, 500ml, 750ml, 1L, nao_engarrafado (ou "N√£o engarrafado"), preco, estoque
  const row = {};
  // copia direto campos comuns (insens√≠vel a mai√∫sculas)
  Object.keys(d).forEach(k=>{
    const klow = k.trim();
    row[klow] = d[k];
  });
  // garantir nome
  row.nome = row.nome || row.Nome || row.name || row['produto'] || row['Produto'] || row['nome do produto'] || '';
  row.descricao = row.descricao || row.Descricao || row.description || '';
  row.imagem = row.imagem || row.Imagem || row.foto || row.photo || '';
  // quantidades: normalizar para n√∫meros (aceitar '', '-', '0')
  const getNum = keyCandidates => {
    for(const key of keyCandidates){
      if(row[key]!==undefined){
        const v = row[key];
        const num = parseFloat(String(v).replace(',','.')) || 0;
        return num;
      }
    }
    return 0;
  };
  row['280ml'] = getNum(['280ml','280','280 ml']);
  row['500ml'] = getNum(['500ml','500','500 ml']);
  row['750ml'] = getNum(['750ml','750','750 ml']);
  row['1L'] = getNum(['1L','1l','1 L','1000ml','1000 ml']);
  // nao engarrafado: pode vir como 'nao_engarrafado' ou 'N√£o engarrafado' ou 'nao engarrafado'
  row['nao_engarrafado'] = getNum(['nao_engarrafado','nao engarrafado','n√£o engarrafado','naoengarrafado','nao_engarrafado','naoengarrafado']);
  // pre√ßo/estoque geral (para produtos n√£o-bebidas)
  row.preco = parseFloat(String(row.preco || row.Preco || row.price || 0).replace(',','.')) || 0;
  row.estoque = parseFloat(String(row.estoque || row.Estoque || row.stock || 0).replace(',','.')) || 0;
  return row;
}

/* ==================== render cat√°logo ==================== */
function renderCatalogo(categoria, abaNome){
  catalogoDiv.innerHTML = '';
  if(!produtosAtuais || produtosAtuais.length===0){
    catalogoDiv.innerHTML = `<div class="catalogo-empty">Nenhum produto encontrado na aba "${abaNome}".</div>`;
    return;
  }
  const bebidasTabs = SUBS_BY_CAT['Bebidas'] || [];
  const isBebida = bebidasTabs.includes(abaNome);
  produtosAtuais.forEach((p, i) => {
    const el = document.createElement('div');
    el.className = 'produto';
    el.innerHTML = `
      <img src="${p.imagem || 'https://via.placeholder.com/400x200?text=Sem+imagem'}" alt="">
      <h3>${p.nome || 'Produto sem nome'}</h3>
      <p>${p.descricao || ''}</p>
    `;
    // Se for bebida: mostramos tabela compacta e bot√£o para abrir modal
    if(isBebida){
      const table = document.createElement('table');
      table.innerHTML = `
        <thead><tr><th>Tamanho</th><th>Qtde</th></tr></thead>
        <tbody>
          <tr><td>280ml</td><td>${p['280ml'] || '-'}</td></tr>
          <tr><td>500ml</td><td>${p['500ml'] || '-'}</td></tr>
          <tr><td>750ml</td><td>${p['750ml'] || '-'}</td></tr>
          <tr><td>1L</td><td>${p['1L'] || '-'}</td></tr>
          <tr><td>N√£o engarrafado</td><td>${p['nao_engarrafado'] || '-'}</td></tr>
        </tbody>
      `;
      el.appendChild(table);
      const btn = document.createElement('button');
      // determinar disponibilidade global (se todas as quantidades 0 => indispon√≠vel)
      const todasZero = [p['280ml'],p['500ml'],p['750ml'],p['1L'],p['nao_engarrafado']].every(v=>!v || v===0);
      btn.textContent = todasZero ? 'Indispon√≠vel' : 'Ver tamanhos';
      if(todasZero) btn.disabled = true;
      btn.className = 'small';
      btn.style.margin = '10px';
      btn.addEventListener('click', ()=> abrirModalBebida(i));
      el.appendChild(btn);
    } else {
      // produto n√£o-bebida (Doces / Sabonetes): usar estoque e preco if present
      const estoqueLabel = (p.estoque && p.estoque>0) ? `<span class="status-disponivel">${p.estoque}</span>` : `<span class="status-indisponivel">Indispon√≠vel</span>`;
      const precoLabel = p.preco ? `R$ ${p.preco}` : '‚Äî';
      const info = document.createElement('div');
      info.innerHTML = `<p><strong>Pre√ßo:</strong> ${precoLabel}</p><p><strong>Estoque:</strong> ${estoqueLabel}</p>`;
      el.appendChild(info);
      const addBtn = document.createElement('button');
      addBtn.textContent = (p.estoque && p.estoque>0) ? 'Adicionar ao carrinho' : 'Indispon√≠vel';
      if(!(p.estoque && p.estoque>0)) addBtn.disabled = true;
      addBtn.style.margin = '10px';
      addBtn.addEventListener('click', ()=> {
        // decrementa uma unidade e adiciona ao carrinho
        p.estoque = (p.estoque || 0) - 1;
        carrinho.push({ nome: p.nome, tamanho: '√önico', preco: p.preco || 0, index: i, sourceAba: abaNome });
        salvarCarrinho();
        renderCatalogo(categoria, abaNome);
        showToast('Adicionado ao carrinho');
      });
      el.appendChild(addBtn);
    }
    catalogoDiv.appendChild(el);
  });
}

/* abre modal para bebida espec√≠fico (tamanhos) */
function abrirModalBebida(index){
  const p = produtosAtuais[index];
  modalNome.textContent = p.nome || '';
  modalTabela.innerHTML = '';
  const sizes = ["280ml","500ml","750ml","1L","N√£o engarrafado"];
  sizes.forEach(sz=>{
    let key = sz === "N√£o engarrafado" ? 'nao_engarrafado' : sz;
    // permissive keys e display
    const displayQty = sz === "N√£o engarrafado" ? (p['nao_engarrafado'] || 0) : (p[sz] || 0);
    const disponivel = (displayQty && Number(displayQty) > 0);
    const statusClass = disponivel ? 'status-disponivel' : 'status-indisponivel';
    let btnHtml = '';
    if(disponivel){
      btnHtml = `<button class="small" onclick="iniciarAddBebida(${index}, '${sz.replace("'", "\\'")}')">Adicionar</button>`;
    }
    modalTabela.insertAdjacentHTML('beforeend', `<tr><td>${sz}</td><td class="${statusClass}">${disponivel ? displayQty : 'Indispon√≠vel'}</td><td>${btnHtml}</td></tr>`);
  });
  produtoModal.classList.add('show');
}

/* iniciarAddBebida: se N√£o engarrafado -> abrir size modal; sen√£o decrementa e adiciona */
function iniciarAddBebida(index, tipo){
  const p = produtosAtuais[index];
  if(tipo === "N√£o engarrafado"){
    const litros = p['nao_engarrafado'] || 0;
    if(!(litros > 0)){ showToast("N√£o engarrafado indispon√≠vel"); return; }
    // abrir modal de sele√ß√£o de tamanho
    sizeContext = { index, tipo, produto: p };
    sizeTitle.textContent = `Escolha o tamanho para ${p.nome}`;
    sizeInfo.textContent = `Estoque dispon√≠vel: ${litros} L`;
    // ativar/desativar bot√µes consoante estoque
    const litersMap = { "280ml":0.28,"500ml":0.5,"750ml":0.75,"1L":1 };
    sizeButtons.querySelectorAll('.size-btn').forEach(btn=>{
      const t = btn.dataset.size;
      const need = litersMap[t] || 0;
      if(litros >= need && need>0){
        btn.disabled = false; btn.style.opacity = "1";
      } else {
        btn.disabled = true; btn.style.opacity = "0.4"; btn.classList.remove('selected');
      }
      btn.classList.remove('selected');
    });
    selectedSize = null;
    confirmSizeBtn.style.display = 'inline-block';
    sizeModal.classList.add('show');
  } else {
    // decrementar unidade do tamanho espec√≠fico: precisamos alterar produtosAtuais e persistir modifica√ß√µes no objeto em mem√≥ria
    // achar objeto e decrementar sua chave respectiva
    const key = tipo === "1L" ? '1L' : tipo;
    // parseFloat seguro
    p[key] = (Number(p[key]||0) - 1);
    // pre√ßo padr√£o por tamanho
    const precoVal = PRECO_POR_TAMANHO[tipo] || 0;
    carrinho.push({ nome: p.nome, tamanho: tipo, preco: precoVal, index, sourceAba: null });
    salvarCarrinho();
    produtoModal.classList.remove('show');
    renderCatalogo(); // redesenha quantidades locais (apenas em mem√≥ria)
    showToast('Adicionado ao carrinho');
  }
}

/* manipula√ß√£o size modal */
let selectedSize = null;
sizeButtons.querySelectorAll('.size-btn').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    sizeButtons.querySelectorAll('.size-btn').forEach(b=>b.classList.remove('selected'));
    btn.classList.add('selected');
    selectedSize = btn.dataset.size;
  });
});
document.getElementById('closeProduto').addEventListener('click', ()=> produtoModal.classList.remove('show'));
document.getElementById('closeSize').addEventListener('click', ()=> { sizeModal.classList.remove('show'); sizeContext = null; });
cancelSizeBtn.addEventListener('click', ()=> { sizeModal.classList.remove('show'); sizeContext = null; });

confirmSizeBtn.addEventListener('click', ()=> {
  if(!sizeContext){ sizeModal.classList.remove('show'); return; }
  if(!selectedSize){ showToast('Selecione um tamanho'); return; }
  const p = sizeContext.produto;
  const litersMap = { "280ml":0.28,"500ml":0.5,"750ml":0.75,"1L":1 };
  const need = litersMap[selectedSize] || 0;
  if((p['nao_engarrafado'] || 0) >= need){
    p['nao_engarrafado'] = +(Number(p['nao_engarrafado']) - need).toFixed(3);
    const precoVal = PRECO_POR_TAMANHO[selectedSize] || 0;
    // push item with index relative to produtosAtuais (we use index from sizeContext)
    carrinho.push({ nome: p.nome, tamanho: selectedSize, preco: precoVal, index: sizeContext.index, sourceAba: null });
    salvarCarrinho();
    sizeModal.classList.remove('show');
    produtoModal.classList.remove('show');
    renderCatalogo();
    showToast('Adicionado ao carrinho');
    sizeContext = null; selectedSize = null;
  } else {
    showToast('Quantidade insuficiente (n√£o engarrafado)');
  }
});

/* ==================== CARRINHO UI ==================== */
carrinhoBtn.addEventListener('click', abrirCarrinho);
document.getElementById('closeCarrinho').addEventListener('click', ()=> carrinhoModal.classList.remove('show'));
window.addEventListener('click', e => {
  if(e.target === produtoModal) produtoModal.classList.remove('show');
  if(e.target === sizeModal) { sizeModal.classList.remove('show'); sizeContext=null; }
  if(e.target === carrinhoModal) carrinhoModal.classList.remove('show');
});

function abrirCarrinho(){
  itensCarrinhoDiv.innerHTML = '';
  if(carrinho.length === 0){
    itensCarrinhoDiv.innerHTML = '<p class="small-muted">Seu carrinho est√° vazio.</p>';
    totalCarrinhoP.textContent = '';
    qrPreview.style.display = 'none';
    carrinhoModal.classList.add('show');
    return;
  }
  let total = 0;
  carrinho.forEach((c,i) => {
    total += Number(c.preco || 0);
    const pElem = document.createElement('p');
    pElem.innerHTML = `<span class="item-left"><strong>${c.nome}</strong><span class="small-muted">${c.tamanho} ¬∑ R$ ${c.preco},00</span></span>
                       <span><button class="danger small" onclick="removerItem(${i})">Remover</button></span>`;
    itensCarrinhoDiv.appendChild(pElem);
  });
  totalCarrinhoP.textContent = `Total: R$ ${total},00`;
  // gerar QR preview (texto simples com valor)
  const qrText = `Pix Bumerangue R$${total.toFixed(2)}`;
  const qrUrl = `https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=${encodeURIComponent(qrText)}`;
  qrPreview.src = qrUrl; qrPreview.style.display = 'block';
  carrinhoModal.classList.add('show');
}

function removerItem(i){
  const item = carrinho[i];
  // se for item com tamanho != 'N√£o engarrafado' e tivermos produtosAtuais index, repor unidade no objeto atual
  if(item.index !== undefined && produtosAtuais[item.index]){
    if(item.tamanho === 'N√£o engarrafado' || item.tamanho === '√önico'){
      // se 'N√£o engarrafado' originalmente reduziu p['nao_engarrafado'] por litros; por√©m aqui armazenamos tamanhos reais, ent√£o podemos repor a quantidade equivalente
      const litersMap = { "280ml":0.28,"500ml":0.5,"750ml":0.75,"1L":1 };
      const need = litersMap[item.tamanho] || 0;
      if(need>0){
        produtosAtuais[item.index]['nao_engarrafado'] = +(Number(produtosAtuais[item.index]['nao_engarrafado']||0) + need).toFixed(3);
      } else {
        // se era unidade embalada (ex: 500ml), tentar repor se chave existir
        const key = item.tamanho;
        if(produtosAtuais[item.index][key] !== undefined){
          produtosAtuais[item.index][key] = Number(produtosAtuais[item.index][key]||0) + 1;
        }
      }
    } else {
      // repor unidade do tamanho espec√≠fico
      const key = item.tamanho;
      if(produtosAtuais[item.index][key] !== undefined){
        produtosAtuais[item.index][key] = Number(produtosAtuais[item.index][key]||0) + 1;
      }
    }
  }
  carrinho.splice(i,1);
  salvarCarrinho();
  abrirCarrinho();
  renderCatalogo(); // atualizar visual
  showToast('Item removido');
}

/* limpar carrinho sem repor estoques (com confirma√ß√£o) */
document.getElementById('limparCarrinho').addEventListener('click', ()=>{
  if(!confirm('Deseja esvaziar o carrinho?')) return;
  carrinho = [];
  salvarCarrinho();
  abrirCarrinho();
  showToast('Carrinho limpo');
});

/* ==================== FINALIZAR PEDIDO (envia ao Apps Script) ==================== */
document.getElementById('finalizarPedido').addEventListener('click', async ()=>{
  const email = (emailClienteInput.value || '').trim();
  if(!email){ showToast('Informe seu e-mail para envio do pedido'); return; }
  if(carrinho.length === 0){ showToast('Carrinho vazio'); return; }
  // preparar payload (array com itens + email no primeiro item para compatibilidade do doPost que voc√™ passou)
  // Seu Apps Script espera um array com itens que contenham email no primeiro item (no exemplo voc√™ fez data[0].email)
  const payload = carrinho.map((c)=>({
    nome: c.nome,
    tamanho: c.tamanho,
    preco: Number(c.preco || 0)
  }));
  // adicionar email no primeiro elemento (seguindo seu doPost)
  payload[0].email = email;
  try {
    // enviar POST para Apps Script
    const resp = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const text = await resp.text();
    // sucesso (Apps Script retorna "Pedido processado com sucesso." no seu exemplo)
    showToast('Pedido enviado. Verifique seu e-mail.');
    // opcional: limpar carrinho
    carrinho = [];
    salvarCarrinho();
    abrirCarrinho();
  } catch(err) {
    console.error(err);
    showToast('Erro ao enviar pedido. Verifique console.');
  }
});

/* ==================== inicializa√ß√£o ==================== */
renderCategoriaBtns();

// auto-abrir primeira subcategoria -> renderSubcats cuidar√° de chamar carregarAba quando o bot√£o for clicado
// para manter UX, clicar no primeiro subcat pai j√° chama o click que faz o fetch

/* salvar carrinho ao carregar a p√°gina para manter persist√™ncia */
salvarCarrinho();

</script>
</body>
</html>
